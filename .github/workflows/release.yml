name: Release ChromeLink

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: native-host/package-lock.json
      
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Validate version consistency
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Check extension manifest.json
          EXT_VERSION=$(jq -r '.version' extension/manifest.json)
          if [ "$EXT_VERSION" != "$VERSION" ]; then
            echo "❌ Extension version mismatch: $EXT_VERSION != $VERSION"
            exit 1
          fi
          
          # Check native-host package.json
          NH_VERSION=$(jq -r '.version' native-host/package.json)
          if [ "$NH_VERSION" != "$VERSION" ]; then
            echo "❌ Native host version mismatch: $NH_VERSION != $VERSION"
            exit 1
          fi
          
          echo "✓ All versions match: $VERSION"
      
      - name: Install native-host dependencies
        working-directory: native-host
        run: npm ci --production
      
      - name: Run tests
        run: |
          cd native-host
          npm ci
          npm test || echo "⚠️ Tests not configured yet"
      
      - name: Create extension zip
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="chromelink-extension-v${VERSION}.zip"
          
          cd extension
          zip -r "../$ZIP_NAME" . \
            -x "*.DS_Store" \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.log"
          
          cd ..
          echo "✓ Created $ZIP_NAME"
          ls -lh "$ZIP_NAME"
      
      - name: Create native-host zip
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="chromelink-native-host-v${VERSION}.zip"
          
          # Create a clean directory for packaging
          mkdir -p release-tmp/native-host
          
          # Copy native-host files
          cp -r native-host/* release-tmp/native-host/
          
          # Copy install scripts
          cp -r install-scripts release-tmp/
          
          # Copy examples
          mkdir -p release-tmp/examples
          cp -r examples/* release-tmp/examples/
          
          # Copy documentation
          cp README.md release-tmp/
          cp QUICKSTART.md release-tmp/ || true
          
          # Create the zip
          cd release-tmp
          zip -r "../$ZIP_NAME" . \
            -x "*.DS_Store" \
            -x "*/node_modules/.cache/*" \
            -x "*/.git/*" \
            -x "*.log"
          
          cd ..
          rm -rf release-tmp
          
          echo "✓ Created $ZIP_NAME"
          ls -lh "$ZIP_NAME"
      
      - name: Create examples zip
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="chromelink-examples-v${VERSION}.zip"
          
          cd examples
          zip -r "../$ZIP_NAME" . \
            -x "*.DS_Store" \
            -x "node_modules/*" \
            -x "*/node_modules/*" \
            -x ".git/*" \
            -x "*.log" \
            -x "*.png" \
            -x "*.txt"
          
          cd ..
          echo "✓ Created $ZIP_NAME"
          ls -lh "$ZIP_NAME"
      
      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "## What's New in v$VERSION" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "Initial release of ChromeLink!" >> CHANGELOG.md
          else
            echo "## What's New in v$VERSION" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### Changes since $PREV_TAG" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # Get commit messages
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "⚠️ **You need to download BOTH files below:**" >> CHANGELOG.md
          echo "- \`chromelink-native-host-v${VERSION}.zip\` - Backend server + installer" >> CHANGELOG.md
          echo "- \`chromelink-extension-v${VERSION}.zip\` - Chrome extension" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Step 1: Install Native Host" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Requirements:** Node.js 18+ and npm" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**All Platforms (macOS/Linux/Windows):**" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "# Download and extract chromelink-native-host-v${VERSION}.zip" >> CHANGELOG.md
          echo "unzip chromelink-native-host-v${VERSION}.zip -d chromelink" >> CHANGELOG.md
          echo "cd chromelink/install-scripts" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# Run installer (same command on all platforms)" >> CHANGELOG.md
          echo "node install.js" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Step 2: Install Extension" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "1. Download \`chromelink-extension-v${VERSION}.zip\`" >> CHANGELOG.md
          echo "2. Extract the zip file" >> CHANGELOG.md
          echo "3. Open Chrome and go to \`chrome://extensions/\`" >> CHANGELOG.md
          echo "4. Enable **Developer mode** (top right)" >> CHANGELOG.md
          echo "5. Click **Load unpacked**" >> CHANGELOG.md
          echo "6. Select the extracted extension folder" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Step 3: Connect Extension to Native Host" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "1. Copy your extension ID from \`chrome://extensions/\`" >> CHANGELOG.md
          echo "2. Run: \`node install.js update-id <your-extension-id>\`" >> CHANGELOG.md
          echo "3. Extension will connect automatically" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Verify Installation" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Run comprehensive diagnostics:" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "node install.js diagnose" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "This checks:" >> CHANGELOG.md
          echo "- Node.js and npm versions" >> CHANGELOG.md
          echo "- Installation directories and files" >> CHANGELOG.md
          echo "- Native messaging manifest" >> CHANGELOG.md
          echo "- Windows Registry (Windows only)" >> CHANGELOG.md
          echo "- Extension ID configuration" >> CHANGELOG.md
          echo "- Server status (port 9000)" >> CHANGELOG.md
          echo "- Log files and locations" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Additional Commands" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "node install.js help          # Show all commands" >> CHANGELOG.md
          echo "node install.js clear-logs    # Clear session logs" >> CHANGELOG.md
          echo "node install.js uninstall     # Remove installation" >> CHANGELOG.md
          echo "node install.js version       # Show installed version" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Troubleshooting" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "If you encounter issues:" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "# Run diagnostics to identify problems" >> CHANGELOG.md
          echo "node install.js diagnose" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# Check logs location (shown in diagnostics)" >> CHANGELOG.md
          echo "# macOS/Linux: ~/.chromelink/native-host/logs/" >> CHANGELOG.md
          echo "# Windows: %USERPROFILE%\\.chromelink\\native-host\\logs\\" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Windows 11 Note:** Both manifest file AND registry entry are required (install.js handles this automatically)" >> CHANGELOG.md
          
          cat CHANGELOG.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ChromeLink v${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            chromelink-extension-v${{ steps.version.outputs.version }}.zip
            chromelink-native-host-v${{ steps.version.outputs.version }}.zip
            chromelink-examples-v${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chromelink-v${{ steps.version.outputs.version }}
          path: |
            chromelink-extension-v${{ steps.version.outputs.version }}.zip
            chromelink-native-host-v${{ steps.version.outputs.version }}.zip
            chromelink-examples-v${{ steps.version.outputs.version }}.zip
          retention-days: 30
